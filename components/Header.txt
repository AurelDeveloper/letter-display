// Correct Client Component directive
'use client'

import { useRouter } from 'next/navigation'
import { TextField } from '@radix-ui/themes'
import { MagnifyingGlassIcon } from '@radix-ui/react-icons'
import { useState, FormEvent, useEffect, useRef } from 'react'
import supabase from '../utils/supabase'
import Link from 'next/link'
import Image from 'next/image'

type Post = { id: string, title: string }

export default function Header() {
    const router = useRouter()
    const [search, setSearch] = useState('')
    const [searchResults, setSearchResults] = useState<Post[]>([])
    const isMounted = useRef(true)

    useEffect(() => {
        return () => {
            isMounted.current = false
        }
    }, [])

    const handleSearch = async (event: FormEvent) => {
        event.preventDefault()
        const { data: posts, error } = await supabase
            .from('posts')
            .select('id, title')
            .ilike('title', `%${search}%`)
        if (error) console.log('Error searching posts:', error)
        else if (isMounted.current) setSearchResults(posts)
    }

    return (
        <header style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '1rem' }}>
            <Image src="/path/to/logo.png" alt="Logo" width={50} height={50} onClick={() => router.push('/')} />
            <form onSubmit={handleSearch}>
                <TextField.Root
                    value={search}
                    onChange={(e) => setSearch(e.target.value)}
                    placeholder="Search posts..."
                >
                    <TextField.Slot>
                        <MagnifyingGlassIcon height="16" width="16" />
                    </TextField.Slot>
                </TextField.Root>
            </form>
            <div>
                {searchResults.map((post: Post) => (
                    <Link href={`/static/${post.id}`} key={post.id}>
                        <a>{post.title}</a>
                    </Link>
                ))}
            </div>
        </header>
    )
}
